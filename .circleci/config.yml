version: 2.1

workflows:
  version: 2.1
  build:
    jobs:
      - build_and_test
orbs:
  browser-tools: circleci/browser-tools@1.1
jobs:
  build_and_test:
    working_directory: ~/cfp_app
    docker:
      - image: cimg/ruby:2.7.6-browsers
        environment:
          PGHOST: localhost
          PGUSER: cfp_app
          RAILS_ENV: test
          CC_TEST_REPORTER_ID: fb19c4a63a7870bfbc633e23e491b7578b1dff19e2085abbc57ef2dd140d704f
      - image: postgres:12.5
        environment:
          POSTGRES_USER: cfp_app
          POSTGRES_DB: cfp_app_test
          POSTGRES_PASSWORD: ""
          POSTGRES_HOST_AUTH_METHOD: trust
    steps:
      - browser-tools/install-browser-tools
      - checkout
      - run: |
          ruby --version
          node --version
          java --version
          google-chrome --version

      - run: gem install bundler
      - run: yarn install
      - run:
        name: Setup Code Climate test-reporter
        command: |
          # Download Code Climate test reporter as a static binary
          curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
          chmod +x ./cc-test-reporter
      - run: ./cc-test-reporter before-build

      # Restore Cached gem Dependencies
      - restore_cache:
          keys:
              - cfp_app-gems-{{ checksum "Gemfile.lock" }}
              - cfp_app-gems-
      # Restore Cached node module Dependencies
      - restore_cache:
          keys:
              - cfp_app-packages-{{ checksum "yarn.lock" }}
              - cfp_app-packages-

      # Bundle install dependencies
      - run: bundle config set path 'vendor/bundle'
      - run: bundle install

      ## Cache Dependencies

      # Generate this fallback cache first because the most recent match
      # will be used even if there is a more precise match
      - save_cache:
          key: cfp_app-gems-
          paths:
              - vendor/bundle
      # Generate a cache for this exact Gemfile.lock
      - save_cache:
          key: cfp_app-gems-{{ checksum "Gemfile.lock" }}
          paths:
              - vendor/bundle
      # Generate a fallback cache of node packages
      - save_cache:
          key: cfp_app-packages-
          paths:
              - node_modules
      # Generate a cache for this exact yarn.lock
      - save_cache:
          key: cfp_app-packages-{{ checksum "yarn.lock" }}
          paths:
              - node_modules

      # Wait for DB
      - run: dockerize -wait tcp://localhost:5432 -timeout 1m

      # Setup the database
      - run: bundle exec rake db:setup

      # Run the tests
      - run: bin/rake

      # Store failed js spec artifacts
      - store_artifacts:
          path: tmp/screenshots
